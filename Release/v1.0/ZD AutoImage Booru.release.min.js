// ==UserScript==
// @name          ZD AutoImage Boorus
// @namespace     https://github.com/ZeroDrako/ZD-AutoImage-Boorus
// @version       1.0
// @description   Add function OneClick-To-Downnload Images from Danbooru, Gelbooru, Safebooru, Sankakucomplex, Yande.re, Rule34.xxx, Furry.booru
// @author        ZeroDrako
// @updateURL     https://raw.githubusercontent.com/ZeroDrako/AutoImage-Boorus/master/ZD%20AutoImage%20Booru.last_release.min.js
// @downloadURL   https://raw.githubusercontent.com/ZeroDrako/AutoImage-Boorus/master/ZD%20AutoImage%20Booru.last_release.min.js
// @license       GPLv3; https://raw.githubusercontent.com/ZeroDrako/AutoImage-Boorus/master/LICENSE
// @include       http://danbooru.donmai.us/*
// @include       http://gelbooru.com/index.php*
// @include       http://safebooru.org/index.php*
// @include       https://chan.sankakucomplex.com/*
// @include       https://yande.re/*
// @include       http://rule34.xxx/index.php*
// @include       http://furry.booru.org/index.php*
// @grant         GM_addStyle
// @grant         GM_getValue
// @grant         GM_setValue
// @grant         GM_xmlhttpRequest
// @require       https://raw.githubusercontent.com/ZeroDrako/Libs/master/jQuery/v1/jquery-1.12.2.min.js
// @require       https://raw.githubusercontent.com/ZeroDrako/Libs/master/FileSaver/v1.1.20160328/FileSaver.min.js
// @icon          http://i1236.photobucket.com/albums/ff444/ZeroDrako/128_zpstpkixbgq.png
// ==/UserScript==
function loadVarPerSite(){if(GM_addStyle("@-webkit-keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}@-o-keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}.progress{overflow:hidden;height:12px;background-color:#f5f5f5;border-radius:4px;-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}.progress-bar{float:left;width:0%;height:100%;font-size:12px;line-height:20px;color:#ffffff;text-align:center;background-color:#337ab7;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);-webkit-transition:width 0.6s ease;-o-transition:width 0.6s ease;transition:width 0.6s ease}.progress-striped .progress-bar,.progress-bar-striped{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:-o-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);-webkit-background-size:40px 40px;background-size:40px 40px}.progress.active .progress-bar,.progress-bar.active{-webkit-animation:progress-bar-stripes 2s linear infinite;-o-animation:progress-bar-stripes 2s linear infinite;animation:progress-bar-stripes 2s linear infinite}.progress-bar-success{background-color:#5cb85c}.progress-striped .progress-bar-success{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:-o-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-info{background-color:#5bc0de}.progress-striped .progress-bar-info{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:-o-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-warning{background-color:#f0ad4e}.progress-striped .progress-bar-warning{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:-o-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-danger{background-color:#d9534f}.progress-striped .progress-bar-danger{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:-o-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}"),GM_addStyle(".ZDOptionTitle{font-size:12px;font-weight:bold;padding-bottom:1%}#ZDdirselect{display:none}#ZDtitle{padding-top:20px}.ZDOptionDown{font-weight:400;float:right!important;margin-right:12%;font-size:11px;border:1px solid #EAEAEA}#ZDdirectory{color:#666;border:1px solid #202529;background:#000}"),/yande\.re/.test(url))yandere=!0,GM_addStyle(".ZDOptionTitle{color:#ee8887!important}#ZDtitle{font-size:14px}.ZDOptionDown{color:#ffbbbb;background:#222}.ZDOptionDown:hover{background:#ee8887;color:white}a.directlink{margin-top:5px!important}");else if(/chan\.sankaku/.test(url)){sankaku=!0,GM_addStyle(".ZDOptionTitle{color:#FF761C!important;font-size:12px;font-weight:bold;padding-bottom:1%}#ZDdirselect{display:none}#ZDdirhelp{margin-right:10%!important;padding:1%!important}#ZDtitle{padding-top:20px;font-size:13px}.ZDOptionDown{float:right!important;margin-right:12%;font-size:11px;font-weight:400!important;color:black;border:1px solid #DDDDDD!important;background:#FAFAFA}.ZDOptionDown:hover{background:#FF761C!important;color:white!important}#ZDdirectory{color:#666;border:1px solid #202529;background:#000}div.content{padding-left:250px!important}");try{mutationEvent()}catch(e){console.log(e)}}else if(/danbooru\.donmai\.us/.test(url))danbooru=!0,GM_addStyle(".ZDOptionTitle{color:#0073ff!important;list-style-type:none}#ZDtitle{color:#0073ff;font-size:14px}.ZDOptionDown{color:black;border:1px solid #EAEAEA;background:white}.ZDOptionDown:hover{background:#F7F7FF;color:black}article.post-preview{height:170px!important}");else if(/gelbooru/.test(url))gelbooru=!0,GM_addStyle(".ZDOptionTitle{color:#1A7FFC!important;list-style-type:none}#ZDtitle{color:black;font-size:18px!important;padding-bottom:10px}.ZDOptionDown{color:black;border:1px solid #EAEAEA;background:white}.ZDOptionDown:hover{background:#E29900;color:white}article.post-preview{height:170px!important}");else if(/safebooru/.test(url))safebooru=!0,GM_addStyle(".ZDOptionTitle{color:#006FFA!important;font-size:12px;font-weight:bold;padding-bottom:1%;list-style-type:none}#ZDdirselect{display:none}#ZDtitle{color:black;padding-top:20px;font-size:13px!important;padding-bottom:10px}.ZDOptionDown{float:right!important;margin-right:12%;font-size:11px;font-weight:400;color:black;border:1px solid #EAEAEA;background:white}.ZDOptionDown:hover{background:#D9E6F7}#ZDdirectory{color:#666;border:1px solid #202529;background:#000}article.post-preview{height:170px!important}");else if(/rule34\.xxx/.test(url))rule34=!0,GM_addStyle(".ZDOptionTitle{color:#009!important;list-style-type:none}#ZDtitle{color:black;font-size:15px!important;padding-bottom:10px}.ZDOptionDown{color:black;border:1px solid #EAEAEA;background:#8ABC8B}.ZDOptionDown:hover{background:#8ABC8B;color:white}article.post-preview{height:170px!important}");else{if(!/furry\.booru/.test(url))return;furry=!0,GM_addStyle(".ZDOptionTitle{color:#1A7FFC!important;list-style-type:none}#ZDtitle{color:black;font-size:14px!important;padding-bottom:10px}.ZDOptionDown{color:black;border:1px solid #EAEAEA;background:white}.ZDOptionDown:hover{background:#E29900;color:white}article.post-preview{height:170px!important}")}}function loadPreferences(){try{document.getElementById("ZDalertdialog").value=GM_getValue("ArtDialog",!1),document.getElementById("ZDdownone").value=GM_getValue("DownloadOne",!1),document.getElementById("ZDdownorig").value=GM_getValue("DownloadOrig",!1),document.getElementById("ZDaddnews").value=GM_getValue("AddNewsFiles",!1),document.getElementById("ZDnumfiles").innerHTML=stringToFiles(GM_getValue("Files","")).length}catch(e){console.log(e.id+" >>> "+e.message)}}function addSettingPanel(){function e(e){function t(){o=document.getElementById("ZDsaved").innerHTML=e}function r(){o=document.getElementById("ZDsaved").innerHTML="&nbsp;"}var o;setTimeout(t,100),setTimeout(r,200),setTimeout(t,300),setTimeout(r,400),setTimeout(t,500),setTimeout(r,1500)}var t=document.createElement("div");t.id="ZDpopup",t.innerHTML='<divid="ZDtitle"><h5>ZDAutoImageBooruv1</h5></div><divclass="wrap"><formid="translateForm"><div><liclass="ZDOptionTitle">DownOne?<selectid="ZDdownone"class="ZDOptionDown"><optionvalue=false>No</option><optionvalue=true>Yes</option></select></li><liclass="ZDOptionTitle">DownOrig?<selectid="ZDdownorig"class="ZDOptionDown"><optionvalue=false>No</option><optionvalue=true>Yes</option></select></li><liclass="ZDOptionTitle">AddNews?<selectid="ZDaddnews"class="ZDOptionDown"><optionvalue=false>No</option><optionvalue=true>Yes</option></select></li><liclass="ZDOptionTitle">AlertDial?<selectid="ZDalertdialog"class="ZDOptionDown"><optionvalue=false>No</option><optionvalue=true>Yes</option></select></li><liclass="ZDOptionTitle">Files:<h7id="ZDnumfiles"></h7><inputid="ZDdirselect"type=filemultiplewebkitdirectorydirectory><inputtype="button"id="ZDdirhelp"class="ZDOptionDown"value="Browse..."onclick="document.getElementById(\'ZDdirselect\').click()"></li></h5></div><pid="ZDsaved"class="ZDoption">&nbsp;</p></form></div>';var r="";if(yandere||sankaku)r="div.sidebar > div";else if(danbooru)r="#sidebar > section#search-box";else{if(!(gelbooru||safebooru||rule34||furry))return;r="#post-list > div.sidebar > div"}document.querySelector(r).appendChild(t),t.addEventListener("change",function(t){switch(t.target.id){case"ZDalertdialog":GM_setValue("ArtDialog","true"===document.getElementById("ZDalertdialog").value?!0:!1),e("Saved!!!");break;case"ZDdownone":GM_setValue("DownloadOne","true"===document.getElementById("ZDdownone").value?!0:!1),e("Saved!!!");break;case"ZDdownorig":GM_setValue("DownloadOrig","true"===document.getElementById("ZDdownorig").value?!0:!1),e("Saved!!!");break;case"ZDaddnews":GM_setValue("AddNewsFiles","true"===document.getElementById("ZDaddnews").value?!0:!1),e("Saved!!!");break;case"ZDdirselect":var r=t.target.files;if(0!==r.length){for(var o,n=0,a=[];o=r[n];n++)(o.type.match("image.*")||o.type.match("video.webm"))&&a.push(o.name);GM_setValue("Files",filesToString(a)),document.getElementById("ZDnumfiles").innerHTML=stringToFiles(GM_getValue("Files","")).length,e("Saved!!!")}break;default:e("Canceled!!!")}})}function mutationEvent(){MutationObserver=window.MutationObserver||window.WebKitMutationObserver;var e=new MutationObserver(function(e,t){for(var r=0;r<e.length;++r)for(var o=0;o<e[r].addedNodes.length;++o)"content-page"===e[r].addedNodes[o].getAttribute("class")&&addProgressBar(e[r].addedNodes[o].getAttribute("id"))});e.observe(document.querySelector("#post-list > div.content"),{childList:!0})}function addProgressBar(e){var t,r;if(yandere)r="p",t=document.querySelectorAll("#post-list-posts > li");else if(sankaku)r="p",t=null!==e?document.querySelectorAll('.content > div[id="'+e+'"] > span'):document.querySelectorAll(".content > div > span");else if(danbooru)r="post_",t=document.querySelectorAll("div#posts > div > article");else{if(!(gelbooru||safebooru||rule34||furry))return;r="s",t=document.querySelectorAll("#post-list > div.content > div > span.thumb")}for(var o=0;o<t.length;o++){var n=document.createElement("div"),a=document.createElement("div"),i=getNameCheck(t[o].id);n.setAttribute("class","progress"),n.setAttribute("id",t[o].id.replace(r,"ZdBarE")),a.setAttribute("class","progress-bar progress-bar-striped"),a.setAttribute("id",t[o].id.replace(r,"ZdBarI")),a.setAttribute("style","width:0%"),downFiles.forEach(function(e){e.match(i)&&a.setAttribute("style","width:100%; background-color: #5CB85C;")}),a.setAttribute("role","progressbar"),GM_getValue("DownloadOne")&&n.addEventListener("click",downloadOne),n.appendChild(a),t[o].appendChild(n)}}function downloadOne(){var e=this.id.replace("ZdBarE",""),t="#ZdBarI"+e;getLink(e,t)}function getLink(e,t){var r,o=new DOMParser,n=document.querySelector(t);if(n.classList.add("active"),n.style="width: 5%; background-color: #F0AD4E;",yandere)r=document.querySelector('#post-list-posts > li[id="p'+e+'"] > div.inner > a.thumb').href;else if(sankaku)r=document.querySelector('.content > div > span[id="p'+e+'"] > a').href;else{if(danbooru){r=document.querySelector('div#posts > div > article[id="post_'+e+'"]').getAttribute("data-file-url"),r="http://danbooru.donmai.us"+r;var a=getNameDown(r);return void downloadCheck(r,a,t)}if(!(gelbooru||safebooru||rule34||furry))return void console.log("Fail at 'getLink' >>> "+e);r=document.querySelector('#post-list > div.content > div > span[id="s'+e+'"] > a').href}GM_xmlhttpRequest({url:r,method:"GET",responseType:"text",onreadystatechange:function(e){if(4===e.readyState&&404===e.status&&console.log("Fail at 'getLink > GM_xmlhttpRequest' >>> "+a),4===e.readyState&&200===e.status){var r=o.parseFromString(e.response,"text/html"),n=null,a=null;if(yandere)n=r.querySelectorAll("#post-view > .sidebar > div:nth-of-type(4) a[id]"),GM_getValue("DownloadOrig")?a=n[n.length-1].getAttribute("href"):(a=n[n.length-2].getAttribute("href"),-1===a.indexOf("files.yande.re")&&(a=n[n.length-1].getAttribute("href")));else if(sankaku)n=r.querySelectorAll(".sidebar  #stats > ul > li > a[id]"),GM_getValue("DownloadOrig")?a=("https:"+n[n.length-1].getAttribute("href")).replace(/(\?(\d+))$/g,""):(a=("https:"+n[n.length-2].getAttribute("href")).replace(/(\?(\d+))$/g,""),-1===a.indexOf("cs.sankakucomplex.com/data/")&&(a=("https:"+n[n.length-1].getAttribute("href")).replace(/(\?(\d+))$/g,"")));else if(gelbooru)a=r.querySelector("div.sidebar3 > div > ul > li > a[href][style]").getAttribute("href");else if(safebooru||rule34||furry){if(GM_getValue("DownloadOrig"))a=r.querySelector("#post-view > .sidebar > div > ul > li > a[href][style]").getAttribute("href");else try{a=r.querySelector("#right-col > div > img").getAttribute("src").replace(/(\?(\d+))$/g,"")}catch(i){a=r.querySelector("#right-col > div > video > source").getAttribute("src").replace(/(\?(\d+))$/g,"")}rule34&&(a="http:"+a)}var s=getNameDown(a);downloadCheck(a,s,t)}},onerror:function(e){n.style="width: 100%; background-color: #D9534F;",n.classList.remove("active"),console.log(e)}})}function getNameDown(e){return decodeURLRecursively(e.substring(e.lastIndexOf("/")+1))}function getNameCheck(e){var t;return yandere?(t=document.querySelector('#post-list-posts > li[id="'+e+'"] img').getAttribute("title"),t=t.substring(t.indexOf("Tags:")+5,t.indexOf("User:")).trim()):sankaku?(t=document.querySelector('.content > div > span[id="'+e+'"] > a > img').src,t=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."))):danbooru?(t=document.querySelector('div#posts > div > article[id="'+e+'"]').getAttribute("data-file-url"),t=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."))):gelbooru||safebooru||rule34||furry?(t=document.querySelector('#post-list > div.content > div > span[id="'+e+'"] > a > img').src,t=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")).replace("thumbnail_","")):(console.log("Fail at 'getLink' >>> "+e),"unknow")}function downloadCheck(e,t,r){var o=document.querySelector(r);if(-1!==downFiles.indexOf(t))if(GM_getValue("ArtDialog")){var n=confirm("File already Downloaded, Download Again???");n===!0?downloadImage(e,t,r):(o.classList.remove("active"),o.style="width: 100%; background-color: #5CB85C;")}else o.classList.remove("active"),o.style="width: 100%; background-color: #5CB85C;",console.log("File already Downloaded!!!");else downloadImage(e,t,r)}function downloadImage(e,t,r){console.log(e),console.log(t);var o=document.querySelector(r);o.style="width: 0%;",GM_xmlhttpRequest({url:e,method:"GET",responseType:"blob",onreadystatechange:function(r){4===r.readyState&&404===r.status&&console.log("Fail at 'downloadImage > GM_xmlhttpRequest' >>> "+e),4===r.readyState&&200===r.status&&(GM_getValue("AddNewsFiles")&&(downFiles.push(t),GM_setValue("Files",filesToString(downFiles)),document.getElementById("ZDnumfiles").innerHTML=stringToFiles(GM_getValue("Files","")).length),saveAs(this.response,t),o.style="width: 100%; background-color: #5CB85C;",o.classList.remove("active"))},onprogress:function(e){GM_getValue("DownloadOne")&&e.lengthComputable&&(o.style="width: "+e.loaded/e.total*100+"%; background-color: #337ab7;")},onerror:function(e){o.style="width: 100%; background-color: #D9534F;",o.classList.remove("active"),console.log(e)}})}function decodeURLRecursively(e){return-1!==e.indexOf("%")?decodeURLRecursively(decodeURIComponent(e)):-1!==e.indexOf("+")?decodeURLRecursively(e.replace("+"," ")):e}function filesToString(e){for(var t=0,r="";t<e.length;t++)r+=e[t]+(t===e.length-1?"":"\\");return r}function stringToFiles(e){return downFiles=[],downFiles=e.split("\\")}function firstLaunch(){for(var e=[["FirstLaunch",!1],["ArtDialog",!1],["DownloadOne",!0],["DownloadOrig",!0],["AddNewsFiles",!0],["Files",""]],t=0;t<e.length;t++)void 0===GM_getValue(e[t][0])&&GM_setValue(e[t][0],e[t][1])}function master(){GM_getValue("FirstLaunch")!==!1&&firstLaunch(),loadVarPerSite(),addSettingPanel(),loadPreferences(),GM_getValue("DownloadOne")&&addProgressBar(null)}var downFiles=[],yandere=!1,sankaku=!1,danbooru=!1,gelbooru=!1,safebooru=!1,rule34=!1,furry=!1,url=window.location.href,downFiles=stringToFiles(GM_getValue("Files",""));master();
